{"version":3,"sources":["HtmlScreen.js"],"names":[],"mappings":"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","file":"src/screen/HtmlScreen.js","sourcesContent":["'use strict';\n\nimport { core } from 'metal';\nimport { dom, globalEval, globalEvalStyles } from 'metal-dom';\nimport CancellablePromise from 'metal-promise';\nimport globals from '../globals/globals';\nimport RequestScreen from './RequestScreen';\nimport Surface from '../surface/Surface';\nimport UA from 'metal-useragent';\nimport Uri from 'metal-uri';\n\nclass HtmlScreen extends RequestScreen {\n\n\t/**\n\t * Screen class that perform a request and extracts surface contents from\n\t * the response content.\n\t * @constructor\n\t * @extends {RequestScreen}\n\t */\n\tconstructor() {\n\t\tsuper();\n\n\t\t/**\n\t\t * Holds the title selector. Relevant to extract the <code><title></code>\n\t\t * element from request fragments to use as the screen title.\n\t\t * @type {!string}\n\t\t * @default title\n\t\t * @protected\n\t\t */\n\t\tthis.titleSelector = 'title';\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tactivate() {\n\t\tsuper.activate();\n\t\tthis.releaseVirtualDocument();\n\t\tthis.pendingStyles = null;\n\t}\n\n\t/**\n\t * Allocates virtual document for content. After allocated virtual document\n\t * can be accessed by <code>this.virtualDocument</code>.\n\t * @param {!string} htmlString\n\t */\n\tallocateVirtualDocumentForContent(htmlString) {\n\t\tif (!this.virtualDocument) {\n\t\t\tthis.virtualDocument = globals.document.createElement('html');\n\t\t}\n\t\tthis.virtualDocument.innerHTML = htmlString;\n\t}\n\n\t/**\n\t * Customizes logic to append styles into document. Relevant to when\n\t * tracking a style by id make sure to re-positions the new style in the\n\t * same dom order.\n\t * @param {Element} newStyle\n\t */\n\tappendStyleIntoDocument_(newStyle) {\n\t\tvar isTemporaryStyle = dom.match(newStyle, HtmlScreen.selectors.stylesTemporary);\n\t\tif (isTemporaryStyle) {\n\t\t\tthis.pendingStyles.push(newStyle);\n\t\t\tif (UA.isIe && newStyle.href) {\n\t\t\t\tnewStyle.href = new Uri(newStyle.href).makeUnique().toString();\n\t\t\t}\n\t\t}\n\t\tif (newStyle.id) {\n\t\t\tvar styleInDoc = globals.document.getElementById(newStyle.id);\n\t\t\tif (styleInDoc) {\n\t\t\t\tstyleInDoc.parentNode.insertBefore(newStyle, styleInDoc.nextSibling);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tglobals.document.head.appendChild(newStyle);\n\t}\n\n\t/**\n\t * If body is used as surface forces the requested documents to have same id\n\t * of the initial page.\n\t */\n\tassertSameBodyIdInVirtualDocument() {\n\t\tvar bodySurface = this.virtualDocument.querySelector('body');\n\t\tif (!globals.document.body.id) {\n\t\t\tglobals.document.body.id = 'senna_surface_' + core.getUid();\n\t\t}\n\t\tif (bodySurface) {\n\t\t\tbodySurface.id = globals.document.body.id;\n\t\t}\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tdisposeInternal() {\n\t\tthis.disposePendingStyles();\n\t\tsuper.disposeInternal();\n\t}\n\n\t/**\n\t * Disposes pending styles if screen get disposed prior to its loading.\n\t */\n\tdisposePendingStyles() {\n\t\tif (this.pendingStyles) {\n\t\t\tthis.pendingStyles.forEach((style) => dom.exitDocument(style));\n\t\t}\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tevaluateScripts(surfaces) {\n\t\tvar evaluateTrackedScripts = this.evaluateTrackedResources_(\n\t\t\tglobalEval.runScriptsInElement, HtmlScreen.selectors.scripts,\n\t\t\tHtmlScreen.selectors.scriptsTemporary, HtmlScreen.selectors.scriptsPermanent);\n\n\t\treturn evaluateTrackedScripts.then(() => super.evaluateScripts(surfaces));\n\t}\n\n\t/**\n\t * @Override\n\t */\n\tevaluateStyles(surfaces) {\n\t\tthis.pendingStyles = [];\n\t\tvar evaluateTrackedStyles = this.evaluateTrackedResources_(\n\t\t\tglobalEvalStyles.runStylesInElement, HtmlScreen.selectors.styles,\n\t\t\tHtmlScreen.selectors.stylesTemporary, HtmlScreen.selectors.stylesPermanent,\n\t\t\tthis.appendStyleIntoDocument_.bind(this));\n\n\t\treturn evaluateTrackedStyles.then(() => super.evaluateStyles(surfaces));\n\t}\n\n\t/**\n\t * Evaluates tracked resources inside incoming fragment and remove existing\n\t * temporary resources.\n\t * @param {?function()} appendFn Function to append the node into document.\n\t * @param {!string} selector Selector used to find resources to track.\n\t * @param {!string} selectorTemporary Selector used to find temporary\n\t *     resources to track.\n\t * @param {!string} selectorPermanent Selector used to find permanent\n\t *     resources to track.\n\t * @param {!function} opt_appendResourceFn Optional function used to\n\t *     evaluate fragment containing resources.\n\t * @return {CancellablePromise} Deferred that waits resources evaluation to\n\t *     complete.\n\t * @private\n\t */\n\tevaluateTrackedResources_(evaluatorFn, selector, selectorTemporary, selectorPermanent, opt_appendResourceFn) {\n\t\tvar tracked = this.virtualQuerySelectorAll_(selector);\n\t\tvar temporariesInDoc = this.querySelectorAll_(selectorTemporary);\n\t\tvar permanentsInDoc = this.querySelectorAll_(selectorPermanent);\n\n\t\t// Adds permanent resources in document to cache.\n\t\tpermanentsInDoc.forEach((resource) => {\n\t\t\tvar resourceKey = this.getResourceKey_(resource);\n\t\t\tif (resourceKey) {\n\t\t\t\tHtmlScreen.permanentResourcesInDoc[resourceKey] = true;\n\t\t\t}\n\t\t});\n\n\t\tvar frag = dom.buildFragment();\n\t\ttracked.forEach((resource) => {\n\t\t\tvar resourceKey = this.getResourceKey_(resource);\n\t\t\t// Do not load permanent resources if already in document.\n\t\t\tif (!HtmlScreen.permanentResourcesInDoc[resourceKey]) {\n\t\t\t\tfrag.appendChild(resource);\n\t\t\t}\n\t\t\t// If resource has key and is permanent add to cache.\n\t\t\tif (resourceKey && dom.match(resource, selectorPermanent)) {\n\t\t\t\tHtmlScreen.permanentResourcesInDoc[resourceKey] = true;\n\t\t\t}\n\t\t});\n\n\t\treturn new CancellablePromise((resolve) => {\n\t\t\tevaluatorFn(frag, () => {\n\t\t\t\ttemporariesInDoc.forEach((resource) => dom.exitDocument(resource));\n\t\t\t\tresolve();\n\t\t\t}, opt_appendResourceFn);\n\t\t});\n\t}\n\n\t/**\n\t * Extracts a key to identify the resource based on its attributes.\n\t * @param {Element} resource\n\t * @return {string} Extracted key based on resource attributes in order of\n\t *     preference: id, href, src.\n\t */\n\tgetResourceKey_(resource) {\n\t\treturn resource.id || resource.href || resource.src || '';\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tgetSurfaceContent(surfaceId) {\n\t\tvar surface = this.virtualDocument.querySelector('#' + surfaceId);\n\t\tif (surface) {\n\t\t\tvar defaultChild = surface.querySelector('#' + surfaceId + '-' + Surface.DEFAULT);\n\t\t\tif (defaultChild) {\n\t\t\t\treturn defaultChild.innerHTML;\n\t\t\t}\n\t\t\treturn surface.innerHTML; // If default content not found, use surface content\n\t\t}\n\t}\n\n\t/**\n\t * Gets the title selector.\n\t * @return {!string}\n\t */\n\tgetTitleSelector() {\n\t\treturn this.titleSelector;\n\t}\n\n\t/**\n\t * @inheritDoc\n\t */\n\tload(path) {\n\t\treturn super.load(path)\n\t\t\t.then(content => {\n\t\t\t\tthis.allocateVirtualDocumentForContent(content);\n\t\t\t\tthis.resolveTitleFromVirtualDocument();\n\t\t\t\tthis.assertSameBodyIdInVirtualDocument();\n\t\t\t\treturn content;\n\t\t\t});\n\t}\n\n\t/**\n\t * Queries elements from virtual document and returns an array of elements.\n\t * @param {!string} selector\n\t * @return {array.<Element>}\n\t */\n\tvirtualQuerySelectorAll_(selector) {\n\t\treturn Array.prototype.slice.call(this.virtualDocument.querySelectorAll(selector));\n\t}\n\n\t/**\n\t * Queries elements from document and returns an array of elements.\n\t * @param {!string} selector\n\t * @return {array.<Element>}\n\t */\n\tquerySelectorAll_(selector) {\n\t\treturn Array.prototype.slice.call(globals.document.querySelectorAll(selector));\n\t}\n\n\t/**\n\t * Releases virtual document allocated for content.\n\t */\n\treleaseVirtualDocument() {\n\t\tthis.virtualDocument = null;\n\t}\n\n\t/**\n\t * Resolves title from allocated virtual document.\n\t */\n\tresolveTitleFromVirtualDocument() {\n\t\tvar title = this.virtualDocument.querySelector(this.titleSelector);\n\t\tif (title) {\n\t\t\tthis.setTitle(title.innerHTML.trim());\n\t\t}\n\t}\n\n\t/**\n\t * Sets the title selector.\n\t * @param {!string} titleSelector\n\t */\n\tsetTitleSelector(titleSelector) {\n\t\tthis.titleSelector = titleSelector;\n\t}\n\n}\n\n/**\n * Helper selectors for tracking resources.\n * @type {object}\n * @protected\n * @static\n */\nHtmlScreen.selectors = {\n\tscripts: 'script[data-senna-track]',\n\tscriptsPermanent: 'script[data-senna-track=\"permanent\"]',\n\tscriptsTemporary: 'script[data-senna-track=\"temporary\"]',\n\tstyles: 'style[data-senna-track],link[data-senna-track]',\n\tstylesPermanent: 'style[data-senna-track=\"permanent\"],link[data-senna-track=\"permanent\"]',\n\tstylesTemporary: 'style[data-senna-track=\"temporary\"],link[data-senna-track=\"temporary\"]'\n};\n\n/**\n * Caches permanent resource keys.\n * @type {object}\n * @protected\n * @static\n */\nHtmlScreen.permanentResourcesInDoc = {};\n\nexport default HtmlScreen;"],"sourceRoot":"/source/"}